ips.templates.set('core.streams.teaser'," <li data-action='insertNewItems' class='ipsStreamItem_loadMore' style='display: none'>  <button class='ipsButton ipsButton_light ipsButton_fullWidth ipsButton_medium'>{{{words}}}</button> </li>");ips.templates.set('core.streams.unreadBar'," <li data-role='unreadBar' class='ipsStreamItem_bar'><hr class='ipsHr'></li>");ips.templates.set('core.streams.noMore'," <li class='ipsType_center ipsType_light ipsType_medium ipsPad'>  {{#lang}}noMoreActivity{{/lang}} </li>");
;(function($,_,undefined){"use strict";ips.controller.register('core.front.streams.main',{_streamLoadingOverlay:null,_streamID:null,_tooltip:null,_tooltipTimer:null,initialize:function(){this.on('click','[data-action="editStream"]',this.showStreamForm);this.on('cancelEditing.streamForm',this.hideStreamForm);this.on('formUpdateLoading.streamForm',this.formUpdateLoading);this.on('formUpdateDone.streamForm',this.formUpdateDone);this.on('click','[data-action="switchView"]',this.switchView);this.on('menuOpened','#elStreamShare',this.menuOpened);this.on('click','[data-action="toggleView"]',this.switchView);this.on('click','[data-action="toggleStreamDefault"]',this.toggleDefault);this.setup();},setup:function(){this._streamID=this.scope.attr('data-streamID');},menuOpened:function(e,data){data.menu.find('input[type="text"]').focus().get(0).select();},toggleDefault:function(e){e.preventDefault();var self=this;var link=$(e.currentTarget);var value=link.attr('data-change');var url=link.attr('href');ips.getAjax()(url).done(function(response){if(value==1){self.scope.find('a[data-action="toggleStreamDefault"][data-change="0"]').removeClass('ipsHide');self.scope.find('a[data-action="toggleStreamDefault"][data-change="1"]').addClass('ipsHide');}else{self.scope.find('a[data-action="toggleStreamDefault"][data-change="0"]').addClass('ipsHide');self.scope.find('a[data-action="toggleStreamDefault"][data-change="1"]').removeClass('ipsHide');}
if(!response.title){$('a[data-action="defaultStream"]').hide();}else{$('a[data-action="defaultStream"]').attr('href',response.url).show().find('span').html(response.title);}
if(value==1){if(!ips.utils.responsive.enabled||!ips.utils.responsive.currentIs('phone')&&$('a[data-action="defaultStream"]').is(':visible')){self._showStreamTooltip(response.tooltip);}else{ips.utils.anim.go('pulseOnce',$('a[data-action="defaultStream"]'));}}});},switchView:function(e){e.preventDefault();var self=this;var type=$(e.currentTarget).attr('data-view');var url=$(e.currentTarget).attr('href');this.scope.find('[data-action="switchView"]').removeClass('ipsButtonRow_active');$(e.currentTarget).addClass('ipsButtonRow_active');ips.utils.cookie.set('stream_view_'+this._streamID,type,true);this._setStreamLoading(true);ips.getAjax()(url,{data:{'_changeView':1}}).done(function(response){self.scope.find('[data-role="streamBody"]').html(response.results);$(document).trigger('contentChange',[self.scope]);}).always(function(){self._setStreamLoading(false);});},formUpdateDone:function(e,data){this.scope.find('[data-role="streamBlurb"]').text(data.blurb);this.scope.find('[data-role="streamContent"]').html(data.results);this.scope.find('[data-role="streamTitle"]').html(data.title);$(document).trigger('contentChange',[this.scope.find('[data-role="streamContent"]')]);if(data.id){var menuItem=$('body').find('[data-streamid="'+data.id+'"] > a');menuItem.text(data.title);}
this.hideStreamForm();this._setStreamLoading(false);},formUpdateLoading:function(e,data){this._setStreamLoading(true);},showStreamForm:function(e){e.preventDefault();this.scope.find('[data-role="streamOverview"]').hide();if(!this.scope.find('[data-controller="core.front.streams.form"]').length)
{this.scope.find('[data-role="filterFormLoading"]').show();ips.utils.anim.go('fadeInDown',this.scope.find('[data-role="filterForm"]'));var data={id:$(e.currentTarget).attr('data-streamID')};var self=this;ips.getAjax()('?app=core&module=discover&controller=streams&form=show',{data:data}).done(function(response){self.scope.find('[data-role="filterForm"]').html(response);$(document).trigger('contentChange',[self.scope.find('[data-role="filterForm"]')]);}).fail(function(){ips.ui.alert.show({type:'alert',message:ips.getString('errorLoadingStream'),icon:'warn'});});}
else{ips.utils.anim.go('fadeInDown',this.scope.find('[data-role="filterForm"]'));}},hideStreamForm:function(){var self=this;this.scope.find('[data-role="filterForm"]').hide();this.scope.find('[data-role="streamOverview"]').fadeIn();},_showStreamTooltip:function(title){if(!this._tooltip){var tooltipHTML=ips.templates.render('core.tooltip',{id:'elDefaultStreamTooltip_'+this.controllerID});ips.getContainer().append(tooltipHTML);this._tooltip=$('#elDefaultStreamTooltip_'+this.controllerID);}else{this._tooltip.hide();}
if(this._tooltipTimer){clearTimeout(this._tooltipTimer);}
this._tooltip.text(ips.getString('streamDefaultTooltip',{title:title}));var streamLink=$('a[data-action="defaultStream"]:visible');var self=this;var positionInfo={trigger:streamLink.first(),target:this._tooltip,center:true,above:true};var tooltipPosition=ips.utils.position.positionElem(positionInfo);$(this._tooltip).css({left:tooltipPosition.left+'px',top:tooltipPosition.top+'px',position:(tooltipPosition.fixed)?'fixed':'absolute',zIndex:ips.ui.zIndex()});if(tooltipPosition.location.vertical=='top'){this._tooltip.addClass('ipsTooltip_top');}else{this._tooltip.addClass('ipsTooltip_bottom');}
this._tooltip.show();setTimeout(function(){if(self._tooltip&&self._tooltip.is(':visible')){ips.utils.anim.go('fadeOut',self._tooltip);}},3000);},_setStreamLoading:function(loading){var stream=this.scope.find('[data-role="streamContent"]');if(!loading){this._streamLoadingOverlay.hide();stream.css({opacity:1});return;}else{if(!this._streamLoadingOverlay){this._streamLoadingOverlay=$('<div/>').addClass('ipsLoading');ips.getContainer().append(this._streamLoadingOverlay);}
var dims=ips.utils.position.getElemDims(stream);var position=ips.utils.position.getElemPosition(stream);this._streamLoadingOverlay.show().css({left:position.viewportOffset.left+'px',top:position.viewportOffset.top+$(document).scrollTop()+'px',width:dims.width+'px',height:dims.height+'px',position:'absolute',zIndex:ips.ui.zIndex()});stream.css({opacity:0.5});}}});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('core.front.streams.form',{initialize:function(){this.on('itemClicked.sideMenu','[data-filterType="type"]',this.selectedType);this.on('itemClicked.sideMenu','[data-filterType="date"]',this.selectedDate);this.on('itemClicked.sideMenu','[data-filterType="ownership"]',this.selectedOwnership);this.on('menuItemSelected','#elStreamSortEdit',this.changeSort);this.on('click','[data-action="removeStream"]',this.removeStream);this.on('click','[data-action="cancelEditing"]',this.cancelEditing);this.on('click','form [type="submit"]',this.submitForm);},changeSort:function(e,data){data.originalEvent.preventDefault();},submitForm:function(e){var self=this;var button=$(e.target);var form=button.closest('form');var type='updateStream';if(this.scope.attr('data-formType')=='createStream'){return;}
e.preventDefault();var data='';var action=form.attr('action');this.trigger('formUpdateLoading.streamForm');if(button.attr('data-action')=='newStream'){data="do=create&";if(this.scope.find('[name="stream_new_title"]').length){this.scope.find('[name="stream_title"]').val(this.scope.find('[name="stream_new_title"]').val());}}else if(button.attr('data-action')=='updateStream'){data="form=save&updateOnly=1&";}else{data="form=save&";}
data+=form.serialize();ips.getAjax()(action,{type:'post',data:data}).done(function(response){self.trigger('formUpdateDone.streamForm',response);}).fail(function(){ips.ui.alert.show({type:'alert',message:ips.getString('errorLoadingStream'),icon:'warn'});});},cancelEditing:function(e){e.preventDefault();this.trigger('cancelEditing.streamForm');},removeStream:function(e){e.preventDefault();ips.ui.alert.show({type:'confirm',message:ips.getString('confirmRemoveStream'),callbacks:{ok:function(){window.location=$(e.currentTarget).attr('href');},}});},selectedDate:function(e,data){if(data.selectedItemID=='custom'){this.scope.find('[data-role="dateRelativeForm"]').slideUp();this.scope.find('[data-role="dateForm"]').slideDown();}else if(data.selectedItemID=='relative'){this.scope.find('[data-role="dateForm"]').slideUp();this.scope.find('[data-role="dateRelativeForm"]').slideDown();this.scope.find('[name="stream_date_relative_days"]').focus();}else{this.scope.find('[data-role="dateForm"]').slideUp();this.scope.find('[data-role="dateRelativeForm"]').slideUp();}},selectedOwnership:function(e,data){if(data.selectedItemID=='custom'){this.scope.find('[data-role="ownershipMemberForm"]').slideDown();}else{this.scope.find('[data-role="ownershipMemberForm"]').slideUp();}},selectedType:function(e,data){var self=this;var typeMenu=this.scope.find('[data-filterType="type"]');var all=typeMenu.find('[data-ipsMenuValue="__all"]');var allButAll=typeMenu.find('[data-ipsMenuValue]:not( [data-ipsMenuValue="__all"] )');var allButAllChecks=allButAll.find('> input[type="checkbox"]');if(data.selectedItemID=='__all'){allButAll.removeClass('ipsSideMenu_itemActive').find('> input[type="checkbox"]').prop('checked',false);all.addClass('ipsSideMenu_itemActive');this.scope.find('input[type="radio"][name="stream_classes_type"][value="0"]').prop('checked',true);this.scope.find('[data-contentType]').slideUp();}else{if(allButAllChecks.filter(':checked').length){all.removeClass('ipsSideMenu_itemActive')
this.scope.find('input[type="radio"][name="stream_classes_type"][value="1"]').prop('checked',true);allButAllChecks.filter(':checked').each(function(){var type=$(this).closest('[data-ipsMenuValue]').attr('data-ipsMenuValue');if(self.scope.find('[data-contentType="'+type+'"]').length){self.scope.find('[data-contentType="'+type+'"]').slideDown();}});allButAllChecks.filter(':not( :checked )').each(function(){var type=$(this).closest('[data-ipsMenuValue]').attr('data-ipsMenuValue');if(self.scope.find('[data-contentType="'+type+'"]').length){self.scope.find('[data-contentType="'+type+'"]').slideUp();}})}else{all.addClass('ipsSideMenu_itemActive').find('> input[type="checkbox"]').prop('checked',true);this.scope.find('[data-contentType]').slideUp();}}}});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('core.front.streams.activity',{_shortInterval:15,_longInterval:45,_killUpdate:45,_timer:null,_killTimer:null,_activityUpdate:null,_loadMore:null,_newUpdates:$('<div/>'),_timestamp:0,_waitingCount:0,_autoUpdate:false,_windowFocus:false,_streamID:0,initialize:function(){this.on('click','[data-action="loadMore"]',this.loadMore);this.on('click','[data-action="insertNewItems"]',this.insertNewItems);this.on(document,ips.utils.events.getVisibilityEvent(),this.windowVisibilityChange);this.setup();},setup:function(){if(this.scope.attr('data-streamID')){this._streamID=this.scope.attr('data-streamID');}
this._timestamp=parseInt(this.scope.find('[data-timestamp]').first().attr('data-timestamp'));if(!_.isUndefined(this.scope.attr('data-autoPoll'))){this._autoUpdate=true;this.windowVisibilityChange();}},windowVisibilityChange:function(){var hiddenProp=ips.utils.events.getVisibilityProp();if(!_.isUndefined(hiddenProp)){if(document[hiddenProp]){this._windowFocus=false;this._startTimer(this._longInterval);this._killTimer=setTimeout(_.bind(this._stopPolling,this),this._killUpdate*60*1000);Debug.log("Set the kill timer");}else{this._windowFocus=true;this._startTimer(this._shortInterval);this._updateTitle(0);clearTimeout(this._killTimer);Debug.log("Cleared the kill timer");}}else{this._startTimer(this._longInterval);}},loadMore:function(e){e.preventDefault();var timestamp=this.scope.find('[data-role="activityItem"]').last().attr('data-timestamp');if(this._loadMore&&_.isFunction(this._loadMore.abort)){this._loadMore.abort();}
this.scope.find('[data-action="loadMore"]').addClass('ipsButton_disabled').text(ips.getString("loading"));var data=(this._streamID)?{id:this._streamID}:{};if(this.scope.attr('data-view')){_.extend(data,{view:this.scope.attr('data-view')});}
this._loadMore=ips.getAjax()('?app=core&module=discover&controller=streams',{data:_.extend(data,{before:timestamp})}).done(_.bind(this._loadMoreResponse,this)).fail(function(jqXHR,textStatus){if(textStatus!=='abort'){ips.ui.alert.show({type:'alert',message:ips.getString('errorLoadingStream'),icon:'warn'});}});},insertNewItems:function(e){e.preventDefault();var insertBefore=null;if(this.scope.find('[data-timeType="past_hour"]').length){insertBefore=this.scope.find('[data-timeType="past_hour"]').siblings('[data-role="activityItem"]').first();this._newUpdates.find('[data-timeType]').remove();}else{insertBefore=this.scope.find('[data-timeType], [data-role="activityItem"]').first();}
this.scope.find('[data-role="unreadBar"]').remove();this._newUpdates.append(ips.templates.render('core.streams.unreadBar'));this._newUpdates.find('[data-role="activityItem"]').attr('data-new',true).css({opacity:0});insertBefore.before(this._newUpdates.html());$(document).trigger('contentChange',[this.scope]);this.scope.find('[data-action="insertNewItems"]').remove();this._animateNewItems();this._newUpdates=$('<div/>');this._waitingCount=0;},_startTimer:function(interval){if(!this._autoUpdate){return;}
if(!interval){interval=this._shortInterval;}
if(this._timer){clearInterval(this._timer);}
this._timer=setInterval(_.bind(this._autoFetchNew,this),interval*1000);},_animateNewItems:function(){var newItems=this.scope.find('[data-new]');var delay=200;newItems.slideDown(function(){newItems.each(function(index){var d=(index*delay);$(this).delay((d>1200)?1200:d).animate({opacity:1}).removeAttr('data-new');});});},_loadMoreResponse:function(response){if(response.count==0){this.scope.find('[data-role="loadMoreContainer"]').replaceWith(ips.templates.render('core.streams.noMore'));return;}
this.scope.find('[data-action="loadMore"]').removeClass('ipsButton_disabled').text(ips.getString('loadNewActivity'));var content=$('<div>'+response.results+'</div>');var latestBubble=this.scope.find('[data-timeType]').last().attr('data-timeType');content.find('[data-timeType="'+latestBubble+'"]').remove();content.find('[data-role="activityItem"]').attr('data-new',true).css({opacity:0});var existingItems=this.scope.find('[data-role="activityItem"]');var count=existingItems.length;existingItems.last().after(content);this.scope.find('[data-role="activityItem"]').slice(count).each(function(){$(document).trigger('contentChange',[$(this)]);});this._animateNewItems();},_stopPolling:function(){clearInterval(this._timer);this._autoUpdate=false;this.scope.find('[data-role="updateMessage"]').html(ips.getString('autoUpdateStopped'));Debug.log("Stopped polling due to user inactivity");},_updateTitle:function(count){},_autoFetchNew:function(e){var self=this;if(!_.isNumber(this._timestamp)||_.isNaN(this._timestamp)){Debug.log("Timestamp not a number");clearInterval(this._timer);return;}
if(this._activityUpdate&&_.isFunction(this._activityUpdate.abort)){this._activityUpdate.abort();}
var data=(this._streamID)?{id:this._streamID}:{};this._activityUpdate=ips.getAjax()('?app=core&module=discover&controller=streams',{data:_.extend(data,{after:this._timestamp})}).done(function(response){var count=parseInt(response.count);if(response.error&&response.error=='auto_polling_disabled'){self.scope.find('[data-role="updateMessage"]').remove();clearInterval(self._timer);return;}
if(_.isNaN(count)||count==0){return;}
var tmp=$('<div>'+response.results+'</div>');self._timestamp=parseInt(tmp.find('[data-timestamp]').first().attr('data-timestamp'));self._waitingCount+=count;if(tmp.find('[data-timeType]').length){var type=tmp.find('[data-timeType]').attr('data-timeType');self._newUpdates.find('[data-timeType="'+type+'"]').remove();}
self._newUpdates.prepend(tmp.contents());if(!self._windowFocus){self._updateTitle(self._waitingCount);}
var teaser=ips.templates.render('core.streams.teaser',{count:self._waitingCount,words:ips.pluralize(ips.getString('newActivityItems'),[self._waitingCount,self._waitingCount])});if(self.scope.find('[data-action="insertNewItems"]').length){self.scope.find('[data-action="insertNewItems"]').replaceWith(teaser);self.scope.find('[data-action="insertNewItems"]').show();}else{self.scope.find('[data-role="activityItem"]').first().before(teaser);self.scope.find('[data-action="insertNewItems"]').slideDown();}}).fail(function(jqXHR,textStatus,errorThrown){if(Debug.isEnabled()){Debug.error(textStatus);}
clearInterval(self._timer);});}});}(jQuery,_));;